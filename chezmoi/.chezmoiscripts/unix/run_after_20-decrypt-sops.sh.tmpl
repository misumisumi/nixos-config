{{- if or (eq .chezmoi.os "linux") (eq .chezmoi.os "darwin") -}}
#!/usr/bin/env bash

if command -v sops &>/dev/null; then
  {{- $chezmoiSrcDir := .chezmoi.sourceDir -}}
  {{ $os := .chezmoi.os -}}
  {{ $sopsFiles := get (get (get . $os) "user") "sops" -}}
  {{ range $src, $tgt := $sopsFiles  -}}
  echo "Decrypting {{ $src }}"
  mkdir -p $(dirname $tgt)
  sops decrypt "{{ $chezmoiSrcDir }}\..\sops/{{ $src }}" > "{{ $tgt }}"
  {{ end }}
else
  echo "'sops' is not in PATH"
fi
{{ end -}}
